rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Registrations collection
    match /registrations/{registrationId} {
      // Allow anyone (authenticated or not) to create a registration
      // This is necessary for the website registration form
      allow create: if true;
      
      // Only authenticated admins can read, update, delete
      allow read: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
      
      // Validate data structure on create
      allow create: if 
        request.resource.data.keys().hasAll(['name', 'phone', 'projectTitle', 'status', 'source', 'createdAt'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.phone is string
        && request.resource.data.phone.size() > 0
        && request.resource.data.projectTitle is string
        && request.resource.data.status in ['new', 'contacted', 'qualified', 'converted', 'archived']
        && request.resource.data.source in ['website_form', 'manual_entry', 'import', 'api'];
      
      // Validate data structure on update (only admins can update)
      allow update: if isAdmin()
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.phone is string
        && request.resource.data.phone.size() > 0
        && request.resource.data.status in ['new', 'contacted', 'qualified', 'converted', 'archived'];
    }
    
    // Projects collection (if you have one)
    match /projects/{projectId} {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Only admins can write
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
